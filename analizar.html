<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Vendas - V4.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; margin: 0; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: rgba(30, 30, 30, 0.9); border-radius: 12px; padding: 15px; border: 1px solid #333; margin-bottom: 20px; }
        .ai-box { border-left: 4px solid #00d4ff; min-height: 80px; }
        .ai-text { color: #00d4ff; font-style: italic; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #333; }
        .price-up { color: #ff4444; }
        .price-down { color: #00ff88; }
        .btn-voltar { background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>

    <header>
        <h1>An√°lise de Vendas</h1>
        <a href="Vendas.html" class="btn-voltar">VOLTAR (NumPad 1)</a>
    </header>

    <div class="card ai-box">
        <h3 style="margin:0; color:#00d4ff">ü§ñ Insight da IA Gemini</h3>
        <p id="ai-content" class="ai-text">Analisando dados do Firebase...</p>
    </div>

    <div class="grid">
        <div class="card">
            <canvas id="pizzaChart"></canvas>
        </div>
        <div class="card" style="max-height: 400px; overflow-y: auto;">
            <h3>Comparativo de Mercado (Manaus)</h3>
            <table>
                <thead>
                    <tr><th>Produto</th><th>Seu Pre√ßo</th><th>Ref. AM</th><th>Diff</th></tr>
                </thead>
                <tbody id="corpo-analise"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyATu9zkykXFpiTD2Mlh5Ee6qroDC1tefi8", authDomain: "ebooklandia-f041aa.firebaseapp.com", projectId: "ebooklandia-f041aa", 
            storageBucket: "ebooklandia-f041aa.firebasestorage.app", messagingSenderId: "316525003872", appId: "1:316525003872:web:5327dac57baabdd3792f05" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // BANCO DE DADOS SIMPLIFICADO PARA A IA N√ÉO SE PERDER
        const produtosManaus = [
            { id: "arroz", preco: 32.50 },
            { id: "feijao", preco: 9.80 },
            { id: "cigarro", preco: 11.00 },
            { id: "garrafinha", preco: 1.50 },
            { id: "cerveja", preco: 5.50 },
            { id: "tucuma", preco: 35.00 }
        ];

        let chartInstance = null;

        function normalizarTexto(txt) {
            return txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        }

        function buscarReferencia(nomeVendido) {
            const nomeLimpo = normalizarTexto(nomeVendido);
            // Procura se alguma palavra do banco est√° dentro do nome vendido
            return produtosManaus.find(p => nomeLimpo.includes(p.id));
        }

        onSnapshot(query(collection(db, "vendas"), orderBy("data", "desc"), limit(20)), (snap) => {
            const corpo = document.getElementById('corpo-analise');
            corpo.innerHTML = "";
            let contagem = {};

            snap.forEach(doc => {
                const v = doc.data();
                const ref = buscarReferencia(v.nome);
                
                let precoRef = "---";
                let diffHtml = "---";

                if(ref) {
                    precoRef = `R$ ${ref.preco.toFixed(2)}`;
                    const diff = v.total - ref.preco;
                    const cor = diff > 0 ? 'price-up' : (diff < 0 ? 'price-down' : '');
                    diffHtml = `<span class="${cor}">${diff > 0 ? '+' : ''}${diff.toFixed(2)}</span>`;
                }

                corpo.innerHTML += `<tr>
                    <td>${v.nome}</td>
                    <td>R$ ${v.total.toFixed(2)}</td>
                    <td>${precoRef}</td>
                    <td>${diffHtml}</td>
                </tr>`;
                
                contagem[v.nome] = (contagem[v.nome] || 0) + 1;
            });

            atualizarGrafico(contagem);
            gerarInsightIA(contagem);
        });

        function gerarInsightIA(dados) {
            const aiContent = document.getElementById('ai-content');
            const lista = Object.entries(dados);
            if(lista.length === 0) return;

            const top = lista.sort((a,b) => b[1] - a[1])[0][0];
            const ref = buscarReferencia(top);

            if(ref) {
                aiContent.innerText = `O produto "${top}" est√° sendo seu carro-chefe. Comparado ao pre√ßo m√©dio de Manaus (R$ ${ref.preco.toFixed(2)}), sua estrat√©gia est√° bem definida.`;
            } else {
                aiContent.innerText = `Notei um alto volume em "${top}". Ainda n√£o tenho esse item na minha base de pre√ßos de Manaus, mas os dados j√° foram salvos para aprendizado.`;
            }
        }

        function atualizarGrafico(dados) {
            const ctx = document.getElementById('pizzaChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dados),
                    datasets: [{ data: Object.values(dados), backgroundColor: ['#00d4ff','#28a745','#dc3545','#ffc107'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } } }
            });
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === '1' || e.code === 'Numpad1') window.location.href = 'Vendas.html';
        });
    </script>
</body>
</html>
