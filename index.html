<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso Restrito - Portal de Vendas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #2d2d2d;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        h1, h2 {
            margin-bottom: 1.5rem;
            color: #ffffff;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 1rem;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #3d3d3d;
            color: white;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button.secondary {
            background-color: #6c757d;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .hidden {
            display: none !important;
        }

        .error-msg {
            color: #ff4d4d;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            min-height: 1.2em;
        }

        .success-msg {
            color: #28a745;
            margin-bottom: 1rem;
        }

        .captcha-box {
            background: #333;
            padding: 15px;
            border: 1px solid #555;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        #timer-display {
            font-weight: bold;
            color: #ffc107;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="container">
        <h2>Acesso ao Portal</h2>
        <p>Digite seu código de acesso (1-9008)</p>
        
        <div id="login-error" class="error-msg"></div>

        <div id="captcha-container" class="hidden captcha-box">
            <p>Verificação de Segurança Necessária</p>
            <p>Quanto é <span id="captcha-q1"></span> + <span id="captcha-q2"></span>?</p>
            <input type="number" id="captcha-input" placeholder="Resultado">
            <button onclick="verificarCaptcha()" type="button">Verificar Humano</button>
        </div>

        <div id="input-area">
            <input type="number" id="access-code" placeholder="Código de acesso" min="1" max="9008">
            <button onclick="tentarLogin()" id="btn-entrar">Entrar</button>
        </div>
        
        <div id="ban-message" class="hidden">
            <p style="color: #ff4d4d;">Acesso BLOQUEADO por segurança.</p>
            <p>Muitas tentativas falhas. Tente novamente em:</p>
            <p id="timer-display">15:00</p>
        </div>
    </div>

    <div id="feedback-screen" class="container hidden">
        <h2>Central de Feedback</h2>
        <p>Analise nossas vendas públicas e nos dê sua opinião.</p>
        
        <div style="text-align: left; background: #333; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
            <strong>Dados Públicos de Vendas:</strong>
            <ul>
                <li>Total de Vendas Hoje: R$ 12.450,00</li>
                <li>Ticket Médio: R$ 150,00</li>
                <li>Conversão: 3.2%</li>
            </ul>
        </div>

        <textarea id="feedback-text" rows="4" placeholder="Escreva sua análise ou sugestão aqui..."></textarea>
        <div id="feedback-msg" class="success-msg hidden"></div>
        
        <button onclick="enviarFeedback()" id="btn-feedback">Enviar Análise para o Firebase</button>
        
        <hr style="border-color: #444; margin: 20px 0;">
        <button onclick="voltarParaLogin()" id="btn-retry" class="secondary">Tentar Acesso Novamente</button>
        <p id="ban-status-text" class="error-msg hidden">Acesso bloqueado temporariamente.</p>
    </div>

    <div id="dashboard-screen" class="container hidden" style="max-width: 800px;">
        <h1 style="color: #28a745;">Acesso Autorizado!</h1>
        <p>Bem-vindo ao Sistema Interno de Vendas.</p>
        <button onclick="location.reload()" style="margin-top: 30px; background-color: #dc3545;">Sair do Sistema</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
        import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATu9zkykXFpiTD2Mlh5Ee6qroDC1tefi8",
            authDomain: "ebooklandia-f041aa.firebaseapp.com",
            projectId: "ebooklandia-f041aa",
            storageBucket: "ebooklandia-f041aa.firebasestorage.app",
            messagingSenderId: "316525003872",
            appId: "1:316525003872:web:5327dac57baabdd3792f05",
            measurementId: "G-MWMF7NW7EH"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Expondo funções para o escopo global (necessário para os botões HTML funcionarem com type="module")
        window.enviarFeedback = async function() {
            const texto = document.getElementById('feedback-text').value;
            const msgDiv = document.getElementById('feedback-msg');
            const now = Date.now();

            if (texto.length < 5) {
                alert("Escreva um feedback mais detalhado.");
                return;
            }

            if (now - lastFeedbackTime < 30000) {
                alert("Anti-spam: Aguarde 30 segundos.");
                return;
            }

            try {
                // SALVANDO NO FIREBASE
                await addDoc(collection(db, "feedbacks"), {
                    mensagem: texto,
                    data: serverTimestamp(),
                    status: "analise"
                });

                lastFeedbackTime = now;
                msgDiv.innerText = "Feedback enviado ao banco de dados com sucesso!";
                msgDiv.classList.remove('hidden');
                document.getElementById('feedback-text').value = "";
            } catch (e) {
                console.error("Erro ao salvar: ", e);
                alert("Erro ao conectar com Firebase.");
            }
        };
    </script>

    <script>
        const TARGET_HASH = "db8e1af0cb3aca1ae2d0018624204529aa2c2753372579a05a15328572d422a5";
        let attempts = 0;
        let captchaSolved = false;
        let lastFeedbackTime = 0;
        let resCaptcha = 0;

        window.onload = function() { verificarBanimento(); };

        async function hashInput(string) {
            const utf8 = new TextEncoder().encode(string);
            const hashBuffer = await crypto.subtle.digest('SHA-256', utf8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function tentarLogin() {
            if (isBanned()) return;
            if (attempts >= 4 && !captchaSolved) {
                gerarCaptcha();
                return;
            }

            const valor = document.getElementById('access-code').value;
            const hashDigitado = await hashInput(valor);

            if (hashDigitado === TARGET_HASH) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
            } else {
                attempts++;
                document.getElementById('access-code').value = '';
                if (attempts === 2) { trocarParaFeedback(); }
                else if (attempts === 4) { gerarCaptcha(); }
                else if (attempts >= 5) { aplicarBanimento(); }
                else { document.getElementById('login-error').innerText = `Incorreto. Tentativa ${attempts}/5`; }
            }
        }

        function gerarCaptcha() {
            document.getElementById('input-area').classList.add('hidden');
            document.getElementById('captcha-container').classList.remove('hidden');
            const n1 = Math.floor(Math.random() * 10) + 1;
            const n2 = Math.floor(Math.random() * 10) + 1;
            resCaptcha = n1 + n2;
            document.getElementById('captcha-q1').innerText = n1;
            document.getElementById('captcha-q2').innerText = n2;
        }

        function verificarCaptcha() {
            const userRes = parseInt(document.getElementById('captcha-input').value);
            if (userRes === resCaptcha) {
                captchaSolved = true;
                document.getElementById('captcha-container').classList.add('hidden');
                document.getElementById('input-area').classList.remove('hidden');
                document.getElementById('login-error').innerText = "Captcha resolvido. Última chance.";
            } else {
                alert("Erro no cálculo.");
                gerarCaptcha();
            }
        }

        function trocarParaFeedback() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('feedback-screen').classList.remove('hidden');
            if (isBanned()) {
                document.getElementById('btn-retry').classList.add('hidden');
                document.getElementById('ban-status-text').classList.remove('hidden');
            }
        }

        function voltarParaLogin() {
            document.getElementById('feedback-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function isBanned() {
            const banTime = localStorage.getItem('site_ban_timestamp');
            if (!banTime) return false;
            return (Date.now() - parseInt(banTime) < 15 * 60 * 1000);
        }

        function aplicarBanimento() {
            localStorage.setItem('site_ban_timestamp', Date.now());
            document.getElementById('input-area').classList.add('hidden');
            document.getElementById('captcha-container').classList.add('hidden');
            document.getElementById('ban-message').classList.remove('hidden');
            iniciarContadorBanimento();
            setTimeout(trocarParaFeedback, 3000);
        }

        function iniciarContadorBanimento() {
            const display = document.getElementById('timer-display');
            const interval = setInterval(() => {
                const banTime = localStorage.getItem('site_ban_timestamp');
                const remaining = (15 * 60 * 1000) - (Date.now() - parseInt(banTime));
                if (remaining <= 0) {
                    clearInterval(interval);
                    localStorage.removeItem('site_ban_timestamp');
                    location.reload();
                } else {
                    const min = Math.floor(remaining / 60000);
                    const sec = Math.floor((remaining % 60000) / 1000);
                    display.innerText = `${min}:${sec < 10 ? '0' : ''}${sec}`;
                }
            }, 1000);
        }

        function verificarBanimento() { if (isBanned()) trocarParaFeedback(); }
    </script>
</body>

</html>
